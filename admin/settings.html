<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Site Settings Â· nijika.de Admin</title>
    <link rel="stylesheet" href="./../assets/styles.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  </head>
  <body>
    <!-- Color Picker Modal -->
    <div class="color-picker-modal" data-color-modal>
      <div class="color-picker-content">
        <div class="color-picker-header">
          <h3>Choose Your Color</h3>
          <button class="color-picker-close" data-color-close>
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div class="color-picker-options">
          <button class="color-option" data-color="cyan" title="Cyan">
            <div class="color-preview" style="background: linear-gradient(135deg, #6de6e2, #a8f5f2);"></div>
            <span>Cyan</span>
          </button>
          <button class="color-option" data-color="pink" title="Pink">
            <div class="color-preview" style="background: linear-gradient(135deg, #ff6b9d, #ffa4c4);"></div>
            <span>Pink</span>
          </button>
          <button class="color-option" data-color="purple" title="Purple">
            <div class="color-preview" style="background: linear-gradient(135deg, #9b59b6, #bb8fce);"></div>
            <span>Purple</span>
          </button>
          <button class="color-option" data-color="green" title="Green">
            <div class="color-preview" style="background: linear-gradient(135deg, #2ecc71, #7fd99f);"></div>
            <span>Green</span>
          </button>
          <button class="color-option" data-color="orange" title="Orange">
            <div class="color-preview" style="background: linear-gradient(135deg, #ff9f43, #ffbe76);"></div>
            <span>Orange</span>
          </button>
          <button class="color-option" data-color="blue" title="Blue">
            <div class="color-preview" style="background: linear-gradient(135deg, #5dade2, #85c1e9);"></div>
            <span>Blue</span>
          </button>
        </div>
      </div>
    </div>

    <div class="neo-container">
      <div class="site-banner">
        <div class="brand">nijika.de</div>
        <div class="header-controls">
          <button class="color-picker-toggle" title="Change color" data-color-picker>
            <i class="bi bi-palette"></i>
          </button>
          <button class="theme-toggle" title="Toggle theme" data-toggle-theme>
            <i class="bi bi-brightness-high"></i>
          </button>
        </div>
      </div>

      <div class="neo-layout">
        <aside class="neo-sidebar">
          <div class="neo-box">
            <div class="neo-header"><h3>Content</h3></div>
            <div class="neo-content">
              <ul>
                <li><a href="./blogs.html">Blogs</a></li>
                <li><a href="./stories.html">Stories</a></li>
                <li><a href="./add-post.html">Add Post</a></li>
              </ul>
            </div>
          </div>
          <div class="neo-box">
            <div class="neo-header"><h3>Site</h3></div>
            <div class="neo-content">
              <ul>
                <li><a href="./status.html">Status Strip</a></li>
                <li><a href="./now.html">Now Page</a></li>
                <li><a href="./changelog.html">Changelog</a></li>
                <li><a href="./resources.html">Resources</a></li>
                <li><a href="./favorites.html">Favorites</a></li>
                <li><a href="./settings.html">Settings</a></li>
              </ul>
            </div>
          </div>
        </aside>

        <main class="neo-main">
          <section class="neo-box">
            <div class="neo-header"><h2><i class="bi bi-gear"></i> Widget Settings</h2></div>
            <div class="neo-content">
              <form id="settingsForm" class="form">
                <div class="field">
                  <label for="spotifyUrl">Spotify Link</label>
                  <input id="spotifyUrl" type="text" placeholder="https://open.spotify.com/track/..." />
                  <small style="color: var(--text-muted);">Paste any Spotify link (track, album, playlist, or embed URL) - it will be converted automatically!</small>
                </div>
                <div class="field">
                  <label for="chattableRoom">Chattable Room Name</label>
                  <input id="chattableRoom" type="text" placeholder="nijikade" />
                  <small style="color: var(--text-muted);">Room name for the chat widget</small>
                </div>
                <button class="btn btn-primary" type="submit">
                  <i class="bi bi-check-lg"></i> Save Settings
                </button>
              </form>
            </div>
          </section>

          <!-- Preview -->
          <section class="neo-box" style="margin-top: 15px;">
            <div class="neo-header"><h3><i class="bi bi-eye"></i> Spotify Preview</h3></div>
            <div class="neo-content">
              <div id="spotifyPreview" style="min-height: 80px;">
                <p style="color: var(--text-muted);">Enter a Spotify URL to see preview</p>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>

    <script type="module">
      import '../assets/app.js';
      
      const API_BASE = 'https://nijikade-backend.vercel.app/api';
      const spotifyInput = document.getElementById('spotifyUrl');
      const chattableInput = document.getElementById('chattableRoom');
      const spotifyPreview = document.getElementById('spotifyPreview');
      
      // Convert any Spotify URL to embed URL
      function spotifyToEmbed(url) {
        if (!url) return '';
        url = url.trim();
        
        // Already an embed URL
        if (url.includes('spotify.com/embed')) {
          return url;
        }
        
        // Match patterns like:
        // https://open.spotify.com/track/3EKh7JNsBrGoh2xqPotBKT?si=f3233a01a3c44f95
        // https://open.spotify.com/album/123abc
        // https://open.spotify.com/playlist/456def
        // spotify:track:3EKh7JNsBrGoh2xqPotBKT
        
        const patterns = [
          // Standard URL: https://open.spotify.com/TYPE/ID?si=...
          /open\.spotify\.com\/(track|album|playlist|artist|episode|show)\/([a-zA-Z0-9]+)/,
          // URI format: spotify:track:ID
          /spotify:(track|album|playlist|artist|episode|show):([a-zA-Z0-9]+)/
        ];
        
        for (const pattern of patterns) {
          const match = url.match(pattern);
          if (match) {
            const type = match[1];
            const id = match[2];
            return `https://open.spotify.com/embed/${type}/${id}?utm_source=generator&theme=0`;
          }
        }
        
        return url; // Return as-is if no pattern matched
      }
      
      // Update preview
      spotifyInput.addEventListener('input', () => {
        const url = spotifyInput.value.trim();
        const embedUrl = spotifyToEmbed(url);
        
        if (embedUrl && embedUrl.includes('spotify.com/embed')) {
          spotifyPreview.innerHTML = `
            <iframe style="border-radius: 12px;" src="${embedUrl}" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
            <small style="color: var(--text-muted); display: block; margin-top: 8px;">
              <i class="bi bi-check-circle" style="color: #2ecc71;"></i> Will be saved as: <code style="font-size: 0.75rem;">${embedUrl}</code>
            </small>
          `;
        } else if (url) {
          spotifyPreview.innerHTML = '<p style="color: orange;"><i class="bi bi-exclamation-triangle"></i> Could not parse Spotify URL. Please paste a valid Spotify link.</p>';
        } else {
          spotifyPreview.innerHTML = '<p style="color: var(--text-muted);">Enter a Spotify URL to see preview</p>';
        }
      });
      
      // Load current settings
      async function loadSettings() {
        try {
          const res = await fetch(`${API_BASE}/site/settings`);
          const data = await res.json();
          spotifyInput.value = data.spotify_embed_url || '';
          chattableInput.value = data.chattable_room || 'nijikade';
          // Trigger preview
          spotifyInput.dispatchEvent(new Event('input'));
        } catch (err) {
          console.error('Failed to load settings:', err);
        }
      }
      
      // Save settings
      document.getElementById('settingsForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('jwt');
        if (!token) return alert('Not logged in');
        
        // Convert to embed URL before saving
        const embedUrl = spotifyToEmbed(spotifyInput.value);
        
        try {
          const res = await fetch(`${API_BASE}/admin/settings?token=${token}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              spotify_embed_url: embedUrl,
              chattable_room: chattableInput.value
            })
          });
          if (res.ok) {
            alert('Settings saved!');
          } else {
            const data = await res.json();
            alert(data.error || 'Failed to save');
          }
        } catch (err) {
          alert('Error saving settings');
        }
      });
      
      loadSettings();
    </script>
  </body>
</html>
