<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Changelog Â· nijika.de Admin</title>
    <link rel="stylesheet" href="./../assets/styles.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <style>
      .changelog-list { display: flex; flex-direction: column; gap: 10px; }
      .changelog-item {
        background: var(--bg-elev);
        border: 1px solid var(--border-light);
        border-radius: 8px;
        padding: 15px;
      }
      .changelog-item.pinned { border-left: 3px solid var(--primary); }
      .changelog-item .meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
      .changelog-item .date { font-size: 0.8rem; color: var(--primary); font-weight: 600; }
      .changelog-item .title { font-weight: 600; color: var(--text); margin-bottom: 5px; }
      .changelog-item .body { font-size: 0.9rem; color: var(--text-muted); }
      .changelog-item .actions { display: flex; gap: 8px; }
      .changelog-item .actions button { padding: 4px 8px; font-size: 0.8rem; }
    </style>
  </head>
  <body>
    <!-- Color Picker Modal -->
    <div class="color-picker-modal" data-color-modal>
      <div class="color-picker-content">
        <div class="color-picker-header">
          <h3>Choose Your Color</h3>
          <button class="color-picker-close" data-color-close>
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div class="color-picker-options">
          <button class="color-option" data-color="cyan" title="Cyan">
            <div class="color-preview" style="background: linear-gradient(135deg, #6de6e2, #a8f5f2);"></div>
            <span>Cyan</span>
          </button>
          <button class="color-option" data-color="pink" title="Pink">
            <div class="color-preview" style="background: linear-gradient(135deg, #ff6b9d, #ffa4c4);"></div>
            <span>Pink</span>
          </button>
          <button class="color-option" data-color="purple" title="Purple">
            <div class="color-preview" style="background: linear-gradient(135deg, #9b59b6, #bb8fce);"></div>
            <span>Purple</span>
          </button>
          <button class="color-option" data-color="green" title="Green">
            <div class="color-preview" style="background: linear-gradient(135deg, #2ecc71, #7fd99f);"></div>
            <span>Green</span>
          </button>
          <button class="color-option" data-color="orange" title="Orange">
            <div class="color-preview" style="background: linear-gradient(135deg, #ff9f43, #ffbe76);"></div>
            <span>Orange</span>
          </button>
          <button class="color-option" data-color="blue" title="Blue">
            <div class="color-preview" style="background: linear-gradient(135deg, #5dade2, #85c1e9);"></div>
            <span>Blue</span>
          </button>
        </div>
      </div>
    </div>

    <div class="neo-container">
      <div class="site-banner">
        <div class="brand">nijika.de</div>
        <div class="header-controls">
          <button class="color-picker-toggle" title="Change color" data-color-picker>
            <i class="bi bi-palette"></i>
          </button>
          <button class="theme-toggle" title="Toggle theme" data-toggle-theme>
            <i class="bi bi-brightness-high"></i>
          </button>
        </div>
      </div>

      <div class="neo-layout">
        <aside class="neo-sidebar">
          <div class="neo-box">
            <div class="neo-header"><h3>Content</h3></div>
            <div class="neo-content">
              <ul>
                <li><a href="./blogs.html">Blogs</a></li>
                <li><a href="./stories.html">Stories</a></li>
                <li><a href="./add-post.html">Add Post</a></li>
              </ul>
            </div>
          </div>
          <div class="neo-box">
            <div class="neo-header"><h3>Site</h3></div>
            <div class="neo-content">
              <ul>
                <li><a href="./status.html">Status Strip</a></li>
                <li><a href="./now.html">Now Page</a></li>
                <li><a href="./changelog.html">Changelog</a></li>
                <li><a href="./resources.html">Resources</a></li>
                <li><a href="./favorites.html">Favorites</a></li>
                <li><a href="./portfolio.html">Portfolio</a></li>
                <li><a href="./settings.html">Settings</a></li>
              </ul>
            </div>
          </div>
        </aside>

        <main class="neo-main">
          <!-- Add New Entry -->
          <section class="neo-box">
            <div class="neo-header"><h2><i class="bi bi-plus-circle"></i> Add Changelog Entry</h2></div>
            <div class="neo-content">
              <form id="addForm" class="form">
                <div class="field">
                  <label for="newTitle">Title (optional)</label>
                  <input id="newTitle" type="text" placeholder="v1.0.0, Feature Update..." />
                </div>
                <div class="field">
                  <label for="newBody">Description</label>
                  <textarea id="newBody" rows="3" placeholder="What changed?" style="width: 100%; padding: 12px; border: 2px solid var(--border-light); border-radius: 8px; background: var(--card); color: var(--text); font-family: inherit; resize: vertical;"></textarea>
                </div>
                <div class="field">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="newPinned" />
                    <span>Pin this entry</span>
                  </label>
                </div>
                <button class="btn btn-primary" type="submit">
                  <i class="bi bi-plus-lg"></i> Add Entry
                </button>
              </form>
            </div>
          </section>

          <!-- Existing Entries -->
          <section class="neo-box" style="margin-top: 15px;">
            <div class="neo-header"><h2><i class="bi bi-list-check"></i> Changelog Entries</h2></div>
            <div class="neo-content">
              <div id="changelogList" class="changelog-list">
                <div class="loading">Loading...</div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>

    <script type="module">
      import '../assets/app.js';
      
      const API_BASE = 'https://nijikade-backend.vercel.app/api';
      const listEl = document.getElementById('changelogList');
      
      async function loadChangelog() {
        try {
          const res = await fetch(`${API_BASE}/site/changelog?limit=50`);
          const entries = await res.json();
          
          if (!entries.length) {
            listEl.innerHTML = '<p style="color: var(--text-muted);">No entries yet.</p>';
            return;
          }
          
          listEl.innerHTML = entries.map(entry => `
            <div class="changelog-item ${entry.pinned ? 'pinned' : ''}" data-id="${entry.id}">
              <div class="meta">
                <span class="date">${entry.date ? new Date(entry.date).toLocaleDateString() : 'No date'}</span>
                <div class="actions">
                  <button class="btn btn-ghost" onclick="editEntry('${entry.id}')"><i class="bi bi-pencil"></i></button>
                  <button class="btn btn-ghost" onclick="deleteEntry('${entry.id}')"><i class="bi bi-trash"></i></button>
                </div>
              </div>
              ${entry.title ? `<div class="title">${entry.title}</div>` : ''}
              <div class="body">${entry.body}</div>
            </div>
          `).join('');
        } catch (err) {
          listEl.innerHTML = '<p style="color: red;">Failed to load</p>';
        }
      }
      
      // Add new entry
      document.getElementById('addForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('jwt');
        if (!token) return alert('Not logged in');
        
        const title = document.getElementById('newTitle').value;
        const body = document.getElementById('newBody').value;
        const pinned = document.getElementById('newPinned').checked;
        
        if (!body.trim()) return alert('Description is required');
        
        try {
          const res = await fetch(`${API_BASE}/admin/changelog?token=${token}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, body, pinned })
          });
          if (res.ok) {
            document.getElementById('newTitle').value = '';
            document.getElementById('newBody').value = '';
            document.getElementById('newPinned').checked = false;
            loadChangelog();
          } else {
            alert('Failed to add entry');
          }
        } catch (err) {
          alert('Error adding entry');
        }
      });
      
      // Delete entry
      window.deleteEntry = async (id) => {
        if (!confirm('Delete this entry?')) return;
        const token = localStorage.getItem('jwt');
        if (!token) return alert('Not logged in');
        
        try {
          const res = await fetch(`${API_BASE}/admin/changelog/${id}?token=${token}`, {
            method: 'DELETE'
          });
          if (res.ok) {
            loadChangelog();
          } else {
            alert('Failed to delete');
          }
        } catch (err) {
          alert('Error deleting');
        }
      };
      
      // Edit entry (simple prompt for now)
      window.editEntry = async (id) => {
        const item = document.querySelector(`[data-id="${id}"]`);
        const currentTitle = item.querySelector('.title')?.textContent || '';
        const currentBody = item.querySelector('.body').textContent;
        
        const newTitle = prompt('Title:', currentTitle);
        if (newTitle === null) return;
        const newBody = prompt('Description:', currentBody);
        if (newBody === null) return;
        
        const token = localStorage.getItem('jwt');
        if (!token) return alert('Not logged in');
        
        try {
          const res = await fetch(`${API_BASE}/admin/changelog/${id}?token=${token}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: newTitle, body: newBody })
          });
          if (res.ok) {
            loadChangelog();
          } else {
            alert('Failed to update');
          }
        } catch (err) {
          alert('Error updating');
        }
      };
      
      loadChangelog();
    </script>
  </body>
</html>
